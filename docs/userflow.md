# Userflow 문서

## 1. 전체 사용자 흐름 개요

```mermaid
flowchart TD
    START([앱 접속]) --> AUTH_CHECK{인증 상태 확인}

    AUTH_CHECK -->|미인증| LOGIN_PAGE[로그인 페이지]
    AUTH_CHECK -->|인증됨| ROOM_LIST[채팅방 목록]

    LOGIN_PAGE --> LOGIN_FLOW[로그인/회원가입]
    LOGIN_FLOW -->|성공| ROOM_LIST
    LOGIN_FLOW -->|실패| LOGIN_PAGE

    ROOM_LIST --> CREATE_ROOM[채팅방 개설]
    ROOM_LIST --> JOIN_ROOM[채팅방 참여]
    ROOM_LIST --> BOOKMARK_LIST[북마크 목록]

    CREATE_ROOM --> CHAT_ROOM[채팅방]
    JOIN_ROOM --> CHAT_ROOM

    CHAT_ROOM --> SEND_MSG[메시지 송신]
    CHAT_ROOM --> REACTION[좋아요]
    CHAT_ROOM --> BOOKMARK[북마크]
    CHAT_ROOM --> DELETE_MSG[메시지 삭제]

    SEND_MSG --> CHAT_ROOM
    REACTION --> CHAT_ROOM
    BOOKMARK --> CHAT_ROOM
    DELETE_MSG --> CHAT_ROOM

    BOOKMARK_LIST --> CHAT_ROOM

    CHAT_ROOM --> LEAVE_ROOM[채팅방 나가기]
    LEAVE_ROOM --> ROOM_LIST
```

---

## 2. 기능별 상세 Userflow

### 2.1 회원가입

#### 입력
- 이메일 주소
- 비밀번호
- 비밀번호 확인

#### 처리
1. 클라이언트 측 입력 유효성 검증
   - 이메일 형식 검증
   - 비밀번호 최소 길이 검증
   - 비밀번호 일치 여부 확인
2. 서버로 회원가입 요청 전송
3. Hono 미들웨어에서 요청 데이터 검증
4. Supabase Auth를 통한 계정 생성
5. 이메일 중복 확인 (Supabase 내부 처리)
6. 계정 생성 성공 시 세션 생성

#### 출력
- 성공: 채팅방 목록 페이지로 리다이렉트
- 실패: 에러 메시지 표시 (중복 이메일, 유효성 오류 등)

#### 엣지케이스
- 이미 가입된 이메일로 재가입 시도
- 네트워크 오류 발생
- 비밀번호 정책 미충족

```mermaid
flowchart TD
    A[회원가입 페이지 접속] --> B[이메일/비밀번호 입력]
    B --> C{클라이언트 유효성 검증}

    C -->|실패| D[유효성 에러 표시]
    D --> B

    C -->|성공| E[서버 요청]
    E --> F{서버 검증}

    F -->|유효성 실패| G[서버 에러 응답]
    G --> D

    F -->|성공| H[Supabase Auth 계정 생성]
    H --> I{계정 생성 결과}

    I -->|이메일 중복| J[중복 에러 표시]
    J --> B

    I -->|성공| K[세션 생성]
    K --> L[채팅방 목록으로 이동]
```

---

### 2.2 로그인

#### 입력
- 이메일 주소
- 비밀번호

#### 처리
1. 클라이언트 측 입력 유효성 검증
   - 이메일 형식 검증
   - 비밀번호 입력 여부 확인
2. 서버로 로그인 요청 전송
3. Hono 미들웨어에서 요청 데이터 검증
4. Supabase Auth를 통한 인증 처리
5. 인증 성공 시 세션 토큰 발급 및 저장

#### 출력
- 성공: 채팅방 목록 페이지로 리다이렉트
- 실패: 에러 메시지 표시 (잘못된 자격 증명 등)

#### 엣지케이스
- 존재하지 않는 계정으로 로그인 시도
- 잘못된 비밀번호 입력
- 세션 토큰 저장 실패
- 네트워크 오류 발생

```mermaid
flowchart TD
    A[로그인 페이지 접속] --> B[이메일/비밀번호 입력]
    B --> C{클라이언트 유효성 검증}

    C -->|실패| D[유효성 에러 표시]
    D --> B

    C -->|성공| E[서버 인증 요청]
    E --> F{Supabase Auth 인증}

    F -->|계정 없음| G[계정 없음 에러]
    F -->|비밀번호 불일치| H[인증 실패 에러]

    G --> I[에러 메시지 표시]
    H --> I
    I --> B

    F -->|성공| J[세션 토큰 발급]
    J --> K[클라이언트 세션 저장]
    K --> L[채팅방 목록으로 이동]
```

---

### 2.3 채팅방 개설

#### 입력
- 채팅방 이름
- 채팅방 설명 (선택)
- 공개 범위 설정

#### 처리
1. 클라이언트 측 입력 유효성 검증
   - 채팅방 이름 필수 입력 확인
   - 채팅방 이름 길이 제한 확인
2. 인증 상태 확인 (미들웨어)
3. 서버로 채팅방 생성 요청 전송
4. Hono 핸들러에서 데이터 검증
5. 채팅방 레코드 생성 (Supabase)
6. 생성자를 채팅방 멤버로 자동 추가

#### 출력
- 성공: 생성된 채팅방으로 이동
- 실패: 에러 메시지 표시

#### 엣지케이스
- 세션 만료 상태에서 생성 시도
- 중복된 채팅방 이름 (정책에 따라)
- 채팅방 생성 수 제한 초과

```mermaid
flowchart TD
    A[채팅방 개설 버튼 클릭] --> B[채팅방 생성 폼 표시]
    B --> C[이름/설명/공개범위 입력]
    C --> D{클라이언트 유효성 검증}

    D -->|실패| E[유효성 에러 표시]
    E --> C

    D -->|성공| F[서버 요청]
    F --> G{인증 상태 확인}

    G -->|미인증| H[로그인 페이지로 이동]

    G -->|인증됨| I{서버 데이터 검증}
    I -->|실패| J[에러 응답]
    J --> E

    I -->|성공| K[채팅방 레코드 생성]
    K --> L[생성자를 멤버로 추가]
    L --> M[생성된 채팅방으로 이동]
```

---

### 2.4 채팅방 참여

#### 입력
- 채팅방 목록 조회 요청
- 검색 키워드 (선택)
- 참여할 채팅방 선택

#### 처리
1. 인증 상태 확인
2. 채팅방 목록 조회 요청
   - 검색어가 있으면 필터링 적용
   - 공개 범위에 따른 접근 가능한 방만 조회
3. 채팅방 선택 시 참여 요청
4. 이미 참여 중인지 확인
5. 신규 참여 시 멤버 레코드 추가
6. 채팅방 입장

#### 출력
- 목록 조회 성공: 채팅방 목록 표시
- 참여 성공: 채팅방 화면으로 이동
- 실패: 에러 메시지 표시

#### 엣지케이스
- 삭제된 채팅방 참여 시도
- 비공개 채팅방 접근 시도
- 채팅방 인원 제한 초과
- 이미 참여 중인 채팅방 재참여

```mermaid
flowchart TD
    A[채팅방 목록 페이지 접속] --> B{인증 상태 확인}

    B -->|미인증| C[로그인 페이지로 이동]

    B -->|인증됨| D[채팅방 목록 조회]
    D --> E{검색어 입력 여부}

    E -->|있음| F[검색 필터 적용]
    E -->|없음| G[전체 목록 표시]

    F --> G
    G --> H[채팅방 선택]
    H --> I{참여 상태 확인}

    I -->|이미 참여 중| J[채팅방 입장]

    I -->|미참여| K{접근 권한 확인}
    K -->|권한 없음| L[접근 불가 메시지]

    K -->|권한 있음| M{인원 제한 확인}
    M -->|초과| N[인원 초과 메시지]

    M -->|여유 있음| O[멤버로 추가]
    O --> J

    J --> P[채팅방 화면]
```

---

### 2.5 메시지 송신

#### 입력
- 메시지 내용 (텍스트/이모지)

#### 처리
1. 인증 상태 확인
2. 채팅방 참여 상태 확인
3. 클라이언트 측 메시지 유효성 검증
   - 빈 메시지 확인
   - 메시지 길이 제한 확인
4. 서버로 메시지 전송 요청
5. Hono 핸들러에서 데이터 검증
6. 메시지 레코드 생성 (Supabase)
7. 낙관적 UI 업데이트 (클라이언트)
8. 폴링을 통한 동기화

#### 출력
- 성공: 메시지가 채팅창에 표시
- 실패: 전송 실패 표시 및 재시도 옵션

#### 엣지케이스
- 세션 만료 상태에서 전송 시도
- 채팅방에서 퇴장된 상태에서 전송 시도
- 네트워크 오류로 인한 전송 실패
- 메시지 길이 초과
- 연속 전송으로 인한 Rate Limit

```mermaid
flowchart TD
    A[메시지 입력] --> B{메시지 유효성 검증}

    B -->|빈 메시지| C[전송 버튼 비활성화]
    B -->|길이 초과| D[길이 초과 경고]

    B -->|유효| E[전송 버튼 클릭]
    E --> F[낙관적 UI 업데이트]
    F --> G[서버 요청]

    G --> H{인증 상태 확인}
    H -->|미인증| I[세션 만료 처리]
    I --> J[로그인 페이지로 이동]

    H -->|인증됨| K{참여 상태 확인}
    K -->|미참여| L[참여 필요 메시지]

    K -->|참여 중| M{Rate Limit 확인}
    M -->|초과| N[잠시 후 재시도 메시지]

    M -->|정상| O[메시지 저장]
    O --> P{저장 결과}

    P -->|실패| Q[전송 실패 표시]
    Q --> R[재시도 옵션 표시]

    P -->|성공| S[전송 완료]
    S --> T[폴링으로 동기화]
```

---

### 2.6 좋아요 (리액션)

#### 입력
- 대상 메시지 선택
- 좋아요 토글 액션

#### 처리
1. 인증 상태 확인
2. 대상 메시지 존재 여부 확인
3. 기존 리액션 상태 확인
4. 토글 처리
   - 리액션이 없으면 추가
   - 리액션이 있으면 제거
5. 리액션 집계 수 갱신

#### 출력
- 성공: 리액션 상태 및 집계 수 업데이트
- 실패: 에러 메시지 표시

#### 엣지케이스
- 삭제된 메시지에 리액션 시도
- 동시에 여러 리액션 요청
- 네트워크 지연으로 인한 중복 요청

```mermaid
flowchart TD
    A[메시지 좋아요 버튼 클릭] --> B{인증 상태 확인}

    B -->|미인증| C[로그인 필요 메시지]

    B -->|인증됨| D[낙관적 UI 업데이트]
    D --> E[서버 요청]

    E --> F{메시지 존재 확인}
    F -->|없음| G[메시지 없음 에러]
    G --> H[UI 롤백]

    F -->|존재| I{기존 리액션 확인}

    I -->|있음| J[리액션 제거]
    I -->|없음| K[리액션 추가]

    J --> L[집계 수 갱신]
    K --> L

    L --> M{처리 결과}
    M -->|실패| H
    M -->|성공| N[최종 상태 반영]
```

---

### 2.7 북마크

#### 입력
- 대상 메시지 선택
- 북마크 토글 액션

#### 처리
1. 인증 상태 확인
2. 대상 메시지 존재 여부 확인
3. 기존 북마크 상태 확인
4. 토글 처리
   - 북마크가 없으면 추가
   - 북마크가 있으면 제거
5. 북마크 목록 갱신

#### 출력
- 성공: 북마크 상태 업데이트
- 실패: 에러 메시지 표시

#### 엣지케이스
- 삭제된 메시지 북마크 시도
- 동시에 여러 북마크 요청
- 북마크 개수 제한 초과

```mermaid
flowchart TD
    A[메시지 북마크 버튼 클릭] --> B{인증 상태 확인}

    B -->|미인증| C[로그인 필요 메시지]

    B -->|인증됨| D[낙관적 UI 업데이트]
    D --> E[서버 요청]

    E --> F{메시지 존재 확인}
    F -->|없음| G[메시지 없음 에러]
    G --> H[UI 롤백]

    F -->|존재| I{기존 북마크 확인}

    I -->|있음| J[북마크 제거]
    I -->|없음| K{북마크 제한 확인}

    K -->|초과| L[제한 초과 메시지]
    L --> H

    K -->|여유| M[북마크 추가]

    J --> N[북마크 목록 갱신]
    M --> N

    N --> O{처리 결과}
    O -->|실패| H
    O -->|성공| P[최종 상태 반영]
```

---

### 2.8 북마크 목록 조회

#### 입력
- 북마크 목록 페이지 접근

#### 처리
1. 인증 상태 확인
2. 사용자의 북마크 목록 조회
3. 각 북마크에 연결된 원본 메시지 정보 조회
4. 삭제된 메시지 처리 (표시 방식 결정)

#### 출력
- 성공: 북마크된 메시지 목록 표시
- 실패: 에러 메시지 표시

#### 엣지케이스
- 북마크가 없는 경우
- 원본 메시지가 삭제된 경우
- 원본 채팅방이 삭제된 경우

```mermaid
flowchart TD
    A[북마크 목록 접근] --> B{인증 상태 확인}

    B -->|미인증| C[로그인 페이지로 이동]

    B -->|인증됨| D[북마크 목록 조회]
    D --> E{북마크 존재 여부}

    E -->|없음| F[빈 목록 안내 표시]

    E -->|있음| G[원본 메시지 정보 조회]
    G --> H{각 메시지 상태 확인}

    H --> I[정상 메시지 표시]
    H --> J[삭제된 메시지 표시]

    I --> K[목록 렌더링]
    J --> K

    K --> L[메시지 클릭 시]
    L --> M{원본 채팅방 존재 확인}

    M -->|없음| N[채팅방 삭제 안내]
    M -->|존재| O[해당 채팅방으로 이동]
```

---

### 2.9 메시지 삭제

#### 입력
- 삭제할 메시지 선택
- 삭제 확인

#### 처리
1. 인증 상태 확인
2. 메시지 존재 여부 확인
3. 메시지 작성자 확인 (본인 여부)
4. 삭제 확인 프로세스
5. 소프트 삭제 또는 하드 삭제 수행
6. 관련 리액션/북마크 처리

#### 출력
- 성공: 메시지 삭제 완료 및 UI에서 제거
- 실패: 에러 메시지 표시

#### 엣지케이스
- 타인의 메시지 삭제 시도
- 이미 삭제된 메시지 재삭제 시도
- 삭제 중 네트워크 오류

```mermaid
flowchart TD
    A[메시지 삭제 버튼 클릭] --> B{인증 상태 확인}

    B -->|미인증| C[로그인 필요 메시지]

    B -->|인증됨| D{작성자 확인}
    D -->|타인 메시지| E[권한 없음 메시지]

    D -->|본인 메시지| F[삭제 확인 모달]
    F --> G{사용자 선택}

    G -->|취소| H[모달 닫기]

    G -->|확인| I[서버 삭제 요청]
    I --> J{메시지 상태 확인}

    J -->|이미 삭제됨| K[이미 삭제됨 메시지]

    J -->|존재| L[메시지 삭제 처리]
    L --> M[관련 데이터 처리]
    M --> N{처리 결과}

    N -->|실패| O[삭제 실패 메시지]
    N -->|성공| P[UI에서 메시지 제거]
```

---

## 3. 화면 전환 흐름

```mermaid
flowchart LR
    subgraph 인증 영역
        LOGIN[로그인]
        SIGNUP[회원가입]
    end

    subgraph 메인 영역
        ROOMS[채팅방 목록]
        ROOM[채팅방]
        BOOKMARKS[북마크 목록]
    end

    LOGIN <-->|전환| SIGNUP

    LOGIN -->|로그인 성공| ROOMS
    SIGNUP -->|가입 성공| ROOMS

    ROOMS -->|방 선택| ROOM
    ROOMS -->|방 생성| ROOM
    ROOMS <-->|전환| BOOKMARKS

    ROOM -->|나가기| ROOMS

    BOOKMARKS -->|메시지 선택| ROOM
```

---

## 4. 인증 상태에 따른 분기 처리

### 4.1 인증 필요 페이지 접근 시

```mermaid
flowchart TD
    A[페이지 접근] --> B{클라이언트 세션 확인}

    B -->|세션 없음| C[로그인 페이지로 리다이렉트]
    C --> D[원래 URL 저장]
    D --> E[로그인 처리]
    E -->|성공| F[저장된 URL로 이동]

    B -->|세션 있음| G{서버 세션 검증}
    G -->|만료/무효| H[세션 삭제]
    H --> C

    G -->|유효| I[페이지 접근 허용]
```

### 4.2 인증 상태 변경 시

```mermaid
flowchart TD
    A[인증 상태 변경 감지] --> B{변경 유형}

    B -->|로그인| C[사용자 정보 로드]
    C --> D[전역 상태 업데이트]
    D --> E[보호된 라우트 접근 허용]

    B -->|로그아웃| F[세션 정보 삭제]
    F --> G[전역 상태 초기화]
    G --> H[로그인 페이지로 이동]

    B -->|세션 만료| I[세션 만료 알림]
    I --> F
```

---

## 5. 에러 처리 흐름

### 5.1 네트워크 에러

```mermaid
flowchart TD
    A[API 요청] --> B{응답 상태}

    B -->|네트워크 오류| C[연결 오류 감지]
    C --> D[오프라인 상태 표시]
    D --> E[자동 재시도 큐에 추가]
    E --> F{연결 복구 감지}
    F -->|복구| G[큐의 요청 재시도]
    F -->|미복구| H[재시도 대기]

    B -->|타임아웃| I[타임아웃 에러]
    I --> J[재시도 옵션 제공]

    B -->|성공| K[정상 처리]
```

### 5.2 서버 에러

```mermaid
flowchart TD
    A[서버 응답] --> B{HTTP 상태 코드}

    B -->|400| C[잘못된 요청 에러]
    C --> D[입력 데이터 검증 메시지]

    B -->|401| E[인증 에러]
    E --> F[로그인 페이지로 이동]

    B -->|403| G[권한 에러]
    G --> H[접근 권한 없음 메시지]

    B -->|404| I[리소스 없음 에러]
    I --> J[존재하지 않음 메시지]

    B -->|429| K[Rate Limit 에러]
    K --> L[잠시 후 재시도 메시지]

    B -->|500| M[서버 내부 에러]
    M --> N[일시적 오류 메시지]
    N --> O[재시도 옵션 제공]
```

### 5.3 클라이언트 에러

```mermaid
flowchart TD
    A[사용자 액션] --> B{유효성 검증}

    B -->|형식 오류| C[필드별 에러 표시]
    C --> D[해당 입력 필드 하이라이트]

    B -->|필수값 누락| E[필수 항목 안내]
    E --> D

    B -->|길이 초과| F[길이 제한 안내]
    F --> D

    B -->|유효| G[정상 처리 진행]
```

---

## 6. 폴링 기반 메시지 동기화 흐름

```mermaid
flowchart TD
    A[채팅방 입장] --> B[폴링 시작]
    B --> C[주기적 메시지 조회 요청]

    C --> D{마지막 메시지 ID 기준}
    D --> E[새 메시지만 조회]

    E --> F{새 메시지 존재}
    F -->|있음| G[메시지 목록에 추가]
    G --> H[UI 업데이트]

    F -->|없음| I[대기]

    H --> J[다음 폴링 대기]
    I --> J

    J --> K{채팅방 상태}
    K -->|활성| C
    K -->|비활성/퇴장| L[폴링 중지]
```

---

## 7. 상태 관리 흐름 (Flux 패턴)

```mermaid
flowchart LR
    A[사용자 액션] --> B[Action Creator]
    B --> C[Dispatcher]
    C --> D[Store/Context]
    D --> E[View 업데이트]
    E --> A

    subgraph 비동기 처리
        B --> F[API 요청]
        F --> G{응답}
        G -->|성공| H[성공 Action]
        G -->|실패| I[실패 Action]
        H --> C
        I --> C
    end
```
